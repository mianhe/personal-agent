# MCP-Powered-Chat 需求文档

## 1. 总体需求说明

### 1.1 需求背景和描述
MCP-Powered-Chat是一个基于命令行界面(CLI)的聊天应用，旨在提供具有动态扩展能力的对话体验。该应用不仅支持与大型语言模型(LLM)的日常对话，还能通过注册Model Context Protocol(MCP)服务器来动态扩展功能，无需修改核心代码。用户可以根据需要添加专用服务器以增强聊天能力，例如股票查询、文档编辑、路线规划、客户信息管理等。

核心目标是创建一个灵活、可扩展的对话平台，让用户能够轻松地根据自己的需求定制功能，同时保持直观和简单的使用体验。

### 1.2 业务上下文和架构

系统采用模块化架构，主要包含以下核心组件：

1. **CLI界面层**：处理用户输入输出，提供命令解析和界面展示
2. **对话引擎**：管理与LLM的连接，处理对话上下文和历史
3. **服务器注册表**：管理MCP服务器的注册和元数据
4. **能力发现系统**：自动发现和整合服务器提供的工具和资源
5. **服务调用引擎**：分析用户意图，选择和调用适当的服务
6. **资源访问层**：处理MCP资源的获取和展示
7. **配置管理**：管理用户设置和系统配置

这些组件协同工作，提供无缝的用户体验，同时保持系统的可扩展性和灵活性。

系统架构示意图

```
+-------------------------------------+
|           MCP-Powered-Chat          |
+-------------------------------------+
|                                     |
|  +-------------------------------+  |
|  |        CLI 界面层            |  |
|  +-------------------------------+  |
|               |                     |
|  +-------------------------------+  |
|  |        对话管理引擎          |  |
|  |   +-----------------------+  |  |
|  |   |     LLM 连接器       |  |  |
|  |   +-----------------------+  |  |
|  |   |     对话上下文       |  |  |
|  |   +-----------------------+  |  |
|  +-------------------------------+  |
|               |                     |
|  +-------------------------------+  |
|  |       服务调用引擎           |  |
|  +-------------------------------+  |
|        |               |            |
|  +-----------+   +-----------+     |
|  | 工具调用  |   | 资源访问  |     |
|  +-----------+   +-----------+     |
|        |               |            |
|  +-------------------------------+  |
|  |      服务器注册表            |  |
|  |   +-----------------------+  |  |
|  |   |    服务器元数据      |  |  |
|  |   +-----------------------+  |  |
|  |   |    能力发现系统      |  |  |
|  |   +-----------------------+  |  |
|  +-------------------------------+  |
|               |                     |
|  +-------------------------------+  |
|  |         配置管理             |  |
|  +-------------------------------+  |
|                                     |
+-------------------------------------+
         |                 |
         v                 v
+----------------+  +----------------+
| MCP 服务器 1   |  | MCP 服务器 2   |
| (股票查询)     |  | (路线规划)     |
+----------------+  +----------------+
```

这个架构图展示了系统的主要组件及其相互关系。用户通过CLI界面与系统交互，对话引擎负责管理LLM连接和对话上下文。服务调用引擎根据需要调用工具或访问资源，而服务器注册表和能力发现系统则使系统能够与多个MCP服务器交互。配置管理确保整个系统可以根据用户偏好进行自定义。

## 2. 特性列表

### 特性1：CLI基本功能
**编码**：cli_basic
**描述**：提供基本的命令行聊天界面，能提供欢迎词，并解析系统级的命令（如：/help）。

**功能点**：
1. 启动基础CLI交付
   - 验收标准：启动后显示欢迎词

2. 解析基础系统命令
   - 验收标准：
     - 在命令行中，按"/"后提示支持的系统命令
     - 能够响应"/exit"命令并正常退出程序
     - 能够响应"/help"命令并提供帮助信息
     - 能够响应"/clear"命令并清屏
     - 命令解析大小写不敏感（如：/HELP 和 /help 效果相同）
     - 空输入应该被忽略

### 特性2：基本LLM对话能力
**编码**：llm_chat
**描述**：集成大型语言模型(LLM)，提供智能、连贯的对话体验。

**功能点**：

1. 与LLM进行基本对话
   - 验收标准：
     - 能够连接 LLM，并回复内容有意义且相关内容
     - 请求进行中时显示"思考中..."等状态

2. 保持对话上下文
   - 验收标准：在多轮对话中，LLM能够记住之前的对话内容并参考

3. 处理网络和模型服务错误
   - 验收标准：在网络或模型服务不稳定情况下（网络超时），系统应该能给出恰当的提示



### 特性3：：mcp_connect
特性描述：支持连接MCP服务器，这样用户就可以使用 mcp的工具来获取信息和解决问题
功能点（通过用户操作流程来承载其详细描述）：
1. 配置服务器
   - 操作流程
     - 用户配置服务器
     - 用户查询服务器配置
   - 验收标准
      - 如果没有配置服务器，则回答没有服务器可用
      - 如果配置了一个服务器，则回答配置的服务器是什么
      - 如果配置了多个服务器，则列出所有可用的服务器

2. 用户指定 MCP 服务器回答问题
   - 操作流程
     - 配置了服务器
     - 用户指定服务器回答问题
     - 回答用户问题
   - 验收标准
      - 当服务器不存在时要回答没有这样的服务器
      - 当服务器连接不上时要回答服务器无法连接
      - 当服务器对回答问题没有帮助时，回答服务器不能提供问题相关的信息
      - 使用服务器过程中，要显示出正在使用服务器

3. 自主决定使用服务器
   - 操作流程
     - 前置条件：用户配置了服务器
     - 用户问问题
     - 回答用户问题
   - 验收标准
      - 当用户的问题适合用服务解答时，系统应该用服务来获取信息比回答问题
      - 当用户的问题不需要服务器就可以直接回答时，应该直接回答
      - 如果适合服务器工具辅助回答，但服务器未给出有效响应，则不采用

### 特性6：工具和资源发现
**描述**：自动发现并显示MCP服务器提供的工具和资源，使这些能力对用户透明可见。

**功能点**：
1. 连接并获取服务器提供的工具列表
   - 验收标准：
     - 服务器注册后自动连接并获取其提供的工具和资源
     - 使用`/tools list [服务器ID]`可查看特定或所有服务器的工具列表
     - 使用`/tools info <工具名称>`可查看工具的详细说明和参数

2. 获取服务器提供的资源列表
   - 验收标准：使用`/resources list [服务器ID]`可查看可用资源

3. 手动刷新服务器能力
   - 验收标准：使用`/refresh <服务器ID>`可手动刷新服务器能力
   - 工具和资源信息在服务器断开连接后仍可查看（本地缓存）

### 特性7：工具自动调用
**描述**：在对话中智能识别用户意图，自动选择和调用合适的工具，无需用户显式命令。

**功能点**：
1. 分析用户消息以确定是否需要工具调用
   - 验收标准：当用户询问相关信息（如"查询苹果公司股票价格"）时，系统能自动识别并使用适当工具

2. 自动选择最合适的工具
   - 验收标准：成功提取并使用正确参数（如股票代码"AAPL"）

3. 提取必要参数并执行调用
   - 验收标准：
     - 工具执行结果被清晰展示并整合到对话响应中
     - 在参数不明确时，系统会主动询问缺失信息

4. 配置自动工具调用
   - 验收标准：
     - 用户可通过`/settings autotools`开启或关闭自动工具调用
     - 在调用工具失败时提供有用的错误信息和替代建议

### 特性8：资源访问
**描述**：支持获取和使用MCP服务器提供的资源，增强对话的信息量和准确性。

**功能点**：
1. 访问文本资源
   - 验收标准：
     - 使用`/resource get <资源URI>`命令可直接获取并显示资源内容
     - 文本资源以格式化方式显示在终端中

2. 查看和展示图片资源
   - 验收标准：图片资源通过适当方式展示（如ASCII图、外部查看器或网页链接）

3. 在对话中引用资源内容
   - 验收标准：在对话中提及相关主题时，系统能自动引用适当资源

4. 浏览可用资源
   - 验收标准：
     - 使用`/resources browse [目录路径]`可浏览资源目录结构
     - 资源内容正确缓存，减少重复请求

### 特性9：会话管理
**描述**：提供保存、恢复和管理对话会话的功能，方便用户管理多个对话。

**功能点**：
1. 保存当前会话
   - 验收标准：使用`/session save [名称]`可保存当前会话状态

2. 加载已保存的会话
   - 验收标准：使用`/session load <名称>`可恢复指定的会话

3. 查看会话列表和元数据
   - 验收标准：使用`/session list`可查看所有保存的会话及其元数据（如创建时间、消息数量）

4. 删除不需要的会话
   - 验收标准：
     - 使用`/session delete <名称>`可删除会话
     - 恢复会话后，历史消息、系统提示和上下文完全重建
     - 会话信息安全存储，保护用户隐私

### 特性10：LLM采样支持
**描述**：实现服务器发起的LLM采样请求处理，使MCP服务器能够使用客户端的语言模型能力。

**功能点**：
1. 接收并处理服务器的采样请求
   - 验收标准：
     - MCP服务器能够发送采样请求并获得客户端LLM生成的文本
     - 客户端显示采样请求的来源和目的

2. 提供采样安全控制
   - 验收标准：用户可通过`/settings sampling`配置采样限制和安全设置

3. 监控采样使用情况
   - 验收标准：
     - 用户可以查看采样使用历史和统计信息
     - 在安全检查失败时能够拒绝采样请求

### 特性11：个性化设置
**描述**：提供应用配置和个性化选项，使用户能够按照自己的喜好定制应用。

**功能点**：
1. 用户配置文件
   - 验收标准：
     - 使用`/settings show`可查看所有当前设置
     - 使用`/settings set <键> <值>`可修改设置
     - 所有设置在应用重启后保持不变

2. UI样式自定义
   - 验收标准：
     - 使用`/theme <主题名>`可切换UI主题
     - 提供至少3种预设主题风格

3. 快捷命令和别名
   - 验收标准：
     - 使用`/alias add <别名> <命令>`可创建命令别名
     - 支持设置保存为配置文件并在启动时加载 