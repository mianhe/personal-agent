# 开发指南

## 代码质量要求

在提交代码之前，所有代码都必须通过预提交检查。你可以通过以下两种方式运行检查：

1. 使用预提交钩子（自动）：
   - 当你执行 `git commit` 时，预提交钩子会自动运行
   - 如果检查失败，提交将被阻止

2. 手动运行检查：
   ```bash
   ./check.sh
   ```

### 检查项目

代码必须通过以下所有检查才能提交：

1. **代码格式化 (black)**
   - 所有 Python 代码必须符合 black 格式化标准
   - 最大行长度：100 字符
   - 使用 `black .` 可以自动格式化代码

2. **代码质量 (pylint)**
   - 代码质量分数必须达到 10/10
   - 主要检查项目：
     - 命名规范
     - 代码复杂度
     - 代码结构
     - 异常处理
     - 导入顺序
   - 特殊规则可以在 `.pylintrc` 中配置

3. **测试要求 (pytest)**
   - 所有测试必须通过
   - 测试覆盖率要求：
     - 总体覆盖率不低于 70%
   - 必须通过的测试：
     - 验收测试（Acceptance Test）
     - 接口测试（Interface Test）

### 测试策略

1. **验收测试（Acceptance Test）**
   - 目标：
     - 验证系统功能是否符合用户需求
     - 确保系统行为符合预期
   - 原则：
     - 从用户场景出发
     - 关注功能而不是实现
     - 测试即文档
     - 不关心具体实现细节

2. **接口测试（Interface Test）**
   - 目标：
     - 验证接口规范
     - 确保实现一致性
     - 保证接口的健壮性
   - 原则：
     - 验证接口规范
     - 测试正常和异常情况
     - 确保实现一致
     - Mock 模块的外部依赖（如数据库、第三方服务）

### 最佳实践

1. **代码组织**
   - 使用清晰的目录结构
   - 保持模块的单一职责
   - 将实现和测试代码分开放置

2. **接口设计**
   - 使用 ABC（Abstract Base Class）定义接口
   - 接口方法使用 @abstractmethod 装饰器
   - 提供完整的类型提示
   - 为所有方法添加文档字符串
   - 定义清晰的错误类型
   - 保持接口简单，只包含必要的方法

3. **版本控制**
   - 提交信息要清晰明了
   - 每个提交只做一件事
   - 保持提交粒度适中

4. **文档**
   - 为所有公共 API 提供文档字符串
   - 保持注释的及时性和准确性
   - 使用清晰的变量和函数命名

### 开发流程

1. **Outside-In Development with Interface Testing**
   - 从 Acceptance Test 开始
     - 写测试描述用户场景
     - 不关心具体实现
     - 测试即文档
   - 在实现过程中定义接口
     - 在写测试/使用代码时，假设需要的接口已经存在
     - 当发现需要新接口时，立即定义它
     - 接口定义要简单，只包含当前需要的功能
     - 接口是自然形成的，不是预先设计的
   - 编写接口测试
     - 验证接口规范
     - 测试正常和异常情况
     - 确保实现一致
   - 实现临时 Mock 版本
     - 实现最简单的版本
     - 用于运行验收测试
     - 验证接口设计
     - 最终会被真实实现替代
   - 实现真实版本
     - 通过接口测试
     - 通过验收测试
     - 保持接口不变

2. **关键原则**
   - 始终从用户场景出发
   - 接口是自然形成的，不是预先设计的
   - 测试驱动开发过程
   - 保持简单直接

3. **代码编写**
   - 遵循 Python 编码规范
   - 编写测试
   - 及时运行检查脚本

4. **提交代码前**
   - 运行 `./check.sh` 确保所有检查通过
   - 检查文档是否更新
   - 确保提交信息符合规范

### 常见问题解决

1. black 格式化失败：
   ```bash
   black .
   ```

2. pylint 警告：
   - 检查 `.pylintrc` 中的规则
   - 必要时添加行内注释禁用特定警告

3. 测试失败：
   - 检查测试输出了解具体失败原因
   - 确保测试环境正确设置
   - 验证测试数据的有效性 